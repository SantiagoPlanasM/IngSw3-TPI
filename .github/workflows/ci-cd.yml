name: ğŸ“ TPI Final Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ====================================================
  # ETAPA 1: BUILD & UNIT TESTS (Reporte Visual)
  # ====================================================
  unit-tests-build:
    name: ğŸ§ª Unit Tests & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Bajar CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¹ Instalar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # PASO 1: Correr tests guardando el resultado en JSON
      # El '|| true' es importante: evita que el pipeline se corte aquÃ­ mismo si falla un test.
      # Queremos que siga al siguiente paso para dibujar la tabla roja antes de morir.
      - name: ğŸ§ª Ejecutar Unit Tests (JSON)
        run: |
          cd backend
          go test ./... -json > test_report.json || true

      # PASO 2: Generar la Tabla Hermosa Fila por Fila
      - name: ğŸ“Š Generar Reporte Detallado
        run: |
          cd backend
          # TÃ­tulo del reporte
          echo "### ğŸ”¬ Reporte Detallado de Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Cabecera de la tabla
          echo "| Clase/Paquete | Test Case | Resultado | DuraciÃ³n |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :---: | :---: |" >> $GITHUB_STEP_SUMMARY
          
          # Magia con JQ: Convierte el JSON de Go en filas de tabla Markdown
          # Filtra solo los eventos 'pass' o 'fail' que tengan nombre de test
          jq -r 'select(.Action == "pass" or .Action == "fail") | select(.Test != null) | "| \(.Package) | \(.Test) | " + (if .Action == "pass" then "âœ… PASS" else "âŒ FAIL" end) + " | \(.Elapsed)s |"' test_report.json >> $GITHUB_STEP_SUMMARY

      # PASO 3: Ahora sÃ­, verificar si hubo fallos para detener el pipeline
      - name: ğŸ›‘ Verificar Fallos
        run: |
          cd backend
          # Buscamos si hay algÃºn "fail" en el archivo JSON
          if grep -q '"Action":"fail"' test_report.json; then
            echo "âŒ Se encontraron tests fallidos. Abortando Build."
            exit 1
          else
            echo "âœ… Todos los tests pasaron."
          fi

      # PASO 4: Build del Frontend (Solo si lo anterior pasÃ³)
      - name: ğŸ“¦ Verificar Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build

  # ====================================================
  # ETAPA 2: INTEGRATION & DEPLOY QA
  # ====================================================
  integration-deploy-qa:
    name: ğŸš€ Integration & QA Deploy
    needs: unit-tests-build # <--- ESTO ASEGURA QUE SI FALLA EL ANTERIOR, ESTE NO CORRE
    runs-on: ubuntu-latest
    environment: 
      name: QA
      url: https://web-pedidos-dev.onrender.com
    
    # Base de datos temporal para pruebas de integraciÃ³n
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: orders_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Bajar CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¹ Instalar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # REQUISITO: "Se corren las pruebas de integraciÃ³n"
      - name: ğŸ”¬ Tests de IntegraciÃ³n
        env:
          DATABASE_URL: postgres://testuser:testpassword@localhost:5432/orders_test?sslmode=disable
        run: |
          cd backend
          go mod download
          go test ./tests/integration/... -v

      # REQUISITO: "Pipeline realiza deploy automÃ¡ticamente a QA"
      - name: ğŸš€ Deploy a Render (QA)
        if: success()
        run: |
          echo "âœ… Tests pasados. Desplegando a QA..."
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}

  # ====================================================
  # ETAPA 3: PASE A PRODUCCIÃ“N (APROBACIÃ“N MANUAL)
  # ====================================================
  deploy-production:
    name: ğŸ† Deploy a ProducciÃ³n
    needs: integration-deploy-qa
    runs-on: ubuntu-latest
    # REQUISITO: "AprobaciÃ³n manual para el pase a PROD"
    environment: 
      name: Production # Al estar protegido en GitHub, pedirÃ¡ permiso
      url: https://ingsw3-tpi-1.onrender.com
    
    steps:
      - name: ğŸš€ Deploy a Render (PROD)
        run: |
          echo "ğŸš¨ AprobaciÃ³n Manual Recibida. Desplegando a PROD..."
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}