name: ğŸš€ Pipeline Profesional CI/CD (QA & PROD)

# Requisito: "Cada pull request aprobado a la rama master debe construir..."
# Esto se dispara al hacer push/merge a main (master)
on:
  push:
    branches: [ "main" ]

jobs:
  # ======================================================
  # ETAPA 1: BUILD & UNIT TESTS
  # Requisito: "Ejecutar tests de unidad, recolectar resultados"
  # ======================================================
  build-and-unit-test:
    name: ğŸ—ï¸ Build & Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # Tests Unitarios (Sin DB real, usando Mocks si los tenÃ©s, o lÃ³gica pura)
      - name: ğŸ§ª Ejecutar Unit Tests
        run: |
          cd backend
          go test ./internal/services/... -v -coverprofile=coverage.out

      # Requisito: "Recolectar y mostrar los resultados" (Artifacts)
      - name: ğŸ“Š Guardar Reporte de Coverage
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: backend/coverage.out

      # VerificaciÃ³n de Build del Frontend (Para asegurar que compila)
      - name: âš›ï¸ Build Frontend Check
        run: |
          cd frontend
          npm ci
          npm run build

  # ======================================================
  # ETAPA 2: DEPLOY A QA & INTEGRATION TESTS
  # Requisito: "Superados los test de unidad... deploy automÃ¡tico a QA... ademÃ¡s pruebas de integraciÃ³n"
  # ======================================================
  deploy-qa-and-integration:
    name: ğŸš€ Deploy QA & Integration Tests
    needs: build-and-unit-test # Si fallan los unitarios, esto no corre
    runs-on: ubuntu-latest
    environment: 
      name: QA
      url: https://web-pedidos-qa.onrender.com # Tu URL de QA
    
    # Levantamos DB efÃ­mera para los tests de integraciÃ³n
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: orders_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # 1. Ejecutar Tests de IntegraciÃ³n (Antes o durante el deploy)
      # Esto asegura que la lÃ³gica integrada (Back + DB) funciona
      - name: ğŸ”¬ Ejecutar Integration Tests
        env:
          DATABASE_URL: postgres://testuser:testpassword@localhost:5432/orders_test?sslmode=disable
        run: |
          cd backend
          go mod download
          # Corremos los tests que tocan la base de datos
          go test ./tests/integration/... -v

      # 2. Si los tests de integraciÃ³n pasan, DESPLEGAMOS A QA
      - name: ğŸš€ Trigger Render Deploy (QA)
        run: |
          echo "âœ… Tests de IntegraciÃ³n exitosos. Desplegando a QA..."
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}

  # ======================================================
  # ETAPA 3: DEPLOY A PRODUCCIÃ“N (MANUAL)
  # Requisito: "Debe existir una aprobaciÃ³n manual para aprobar el pase a ProducciÃ³n"
  # ======================================================
  deploy-production:
    name: ğŸ† Deploy to Production
    needs: deploy-qa-and-integration
    runs-on: ubuntu-latest
    # AquÃ­ GitHub frena el pipeline y espera tu aprobaciÃ³n porque configuramos el Environment
    environment: 
      name: Production
      url: https://web-pedidos-prod.onrender.com # Tu URL de Prod
    
    steps:
      - name: ğŸ›‘ AprobaciÃ³n Manual Verificada
        run: echo "Manual approval granted. Deploying to Production..."

      - name: ğŸš€ Trigger Render Deploy (PROD)
        run: |
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}