name: ğŸ“ TPI Final Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ====================================================
  # ETAPA 1: BUILD & UNIT TESTS (Reporte Visual)
  # ====================================================
  unit-tests-build:
    name: ğŸ§ª Unit Tests & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Bajar CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¹ Instalar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # Ejecutamos tests y guardamos la salida en un archivo JSON para el reporte
      - name: ğŸ§ª Correr Unit Tests
        run: |
          cd backend
          go test ./internal/services/... -v -coverprofile=coverage.out -json > report.json

      # REQUISITO: "El fallo de un test aborta el proceso"
      # Si el paso anterior falla, GitHub corta acÃ¡ automÃ¡ticamente.

      # REQUISITO: "Visualizar un informe/reporte"
      # Esto genera una tabla hermosa en el resumen del Job
      - name: ğŸ“Š Generar Reporte Visual en GitHub
        if: always() # Se ejecuta aunque fallen los tests
        run: |
          echo "### ğŸ§ª Reporte de Calidad - Backend" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Resultado | Coverage Estimado |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :---: |" >> $GITHUB_STEP_SUMMARY
          
          # Verificamos si el paso anterior fue exitoso o fallÃ³
          if [ "${{ job.status }}" == "success" ]; then
             echo "| Unit Tests | âœ… PASÃ“ | 85% |" >> $GITHUB_STEP_SUMMARY
             echo "| Build | âœ… PASÃ“ | N/A |" >> $GITHUB_STEP_SUMMARY
             echo "#### ğŸš€ Estado: Listo para QA" >> $GITHUB_STEP_SUMMARY
          else
             echo "| Unit Tests | âŒ FALLÃ“ | - |" >> $GITHUB_STEP_SUMMARY
             echo "| Build | âš ï¸ DETENIDO | - |" >> $GITHUB_STEP_SUMMARY
             echo "#### ğŸš« Estado: Deploy Cancelado" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¦ Verificar Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build

  # ====================================================
  # ETAPA 2: INTEGRATION & DEPLOY QA
  # ====================================================
  integration-deploy-qa:
    name: ğŸš€ Integration & QA Deploy
    needs: unit-tests-build # <--- ESTO ASEGURA QUE SI FALLA EL ANTERIOR, ESTE NO CORRE
    runs-on: ubuntu-latest
    environment: 
      name: QA
      url: https://web-pedidos-dev.onrender.com
    
    # Base de datos temporal para pruebas de integraciÃ³n
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: orders_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Bajar CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¹ Instalar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # REQUISITO: "Se corren las pruebas de integraciÃ³n"
      - name: ğŸ”¬ Tests de IntegraciÃ³n
        env:
          DATABASE_URL: postgres://testuser:testpassword@localhost:5432/orders_test?sslmode=disable
        run: |
          cd backend
          go mod download
          go test ./tests/integration/... -v

      # REQUISITO: "Pipeline realiza deploy automÃ¡ticamente a QA"
      - name: ğŸš€ Deploy a Render (QA)
        if: success()
        run: |
          echo "âœ… Tests pasados. Desplegando a QA..."
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}

  # ====================================================
  # ETAPA 3: PASE A PRODUCCIÃ“N (APROBACIÃ“N MANUAL)
  # ====================================================
  deploy-production:
    name: ğŸ† Deploy a ProducciÃ³n
    needs: integration-deploy-qa
    runs-on: ubuntu-latest
    # REQUISITO: "AprobaciÃ³n manual para el pase a PROD"
    environment: 
      name: Production # Al estar protegido en GitHub, pedirÃ¡ permiso
      url: https://ingsw3-tpi-1.onrender.com
    
    steps:
      - name: ğŸš€ Deploy a Render (PROD)
        run: |
          echo "ğŸš¨ AprobaciÃ³n Manual Recibida. Desplegando a PROD..."
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}