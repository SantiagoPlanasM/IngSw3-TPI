name: CI - Integraci贸n Continua

# Se ejecuta cuando empuj谩s a main o hac茅s un Pull Request
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Backend (Go + PostgreSQL)
  # ------------------------------------------------------------------
  backend-test:
    name:  Test Backend (Go)
    runs-on: ubuntu-latest
    
    # Levantamos un Postgres temporal para los tests de integraci贸n
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: orders_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Bajar c贸digo
        uses: actions/checkout@v4

      - name: Instalar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Instalar dependencias
        run: |
          cd backend
          go mod download

      - name: Correr Tests
        env:
          # Variables para que Go se conecte al Postgres de prueba
          DATABASE_URL: postgres://testuser:testpassword@localhost:5432/orders_test?sslmode=disable
          PORT: 8080
        run: |
          cd backend
          # Corre todos los tests (Unitarios + Integraci贸n)
          go test ./... -v

  # ------------------------------------------------------------------
  # JOB 2: Frontend (React + Vite)
  # ------------------------------------------------------------------
  frontend-build-check:
    name: 锔 Test Frontend Build
    runs-on: ubuntu-latest

    steps:
      - name: Bajar c贸digo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar dependencias
        run: |
          cd frontend
          npm ci

      - name: Verificar compilaci贸n (Build)
        # Esto asegura que no subas c贸digo con errores de sintaxis que rompan React
        run: |
          cd frontend
          npm run build