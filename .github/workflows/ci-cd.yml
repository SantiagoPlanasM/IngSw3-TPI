vname: CI/CD con Environments

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ====================================================
  # JOB 1: CI - Tests & Build Check (Siempre corre)
  # ====================================================
  ci-tests:
    name: ğŸ§ª CI - Test & Validate
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: orders_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: ğŸ§ª Run Backend Tests
        env:
          DATABASE_URL: postgres://testuser:testpassword@localhost:5432/orders_test?sslmode=disable
        run: |
          cd backend
          go mod download
          go test ./... -v

      - name: âš›ï¸ Verify Frontend Build
        run: |
          cd frontend
          npm ci
          npm run build

  # ====================================================
  # JOB 2: CD - Deploy a DEVELOPMENT
  # ====================================================
  deploy-dev:
    name: ğŸš€ Deploy to Dev
    needs: ci-tests
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: 
      name: Development
      url: https://web-pedidos-dev.onrender.com # CambiÃ¡ esto por tu URL real
    
    steps:
      - name: ğŸš€ Trigger Render Deploy (Dev)
        run: |
          echo "Deploying to Development Environment..."
          # Llamamos a los Hooks que guardaste en los secretos de 'Development'
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}

  # ====================================================
  # JOB 3: CD - Deploy a PRODUCTION
  # ====================================================
  deploy-prod:
    name: ğŸš€ Deploy to Production
    needs: ci-tests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: 
      name: Production
      url: https://web-pedidos-prod.onrender.com # CambiÃ¡ esto por tu URL real
    
    steps:
      - name: ğŸš€ Trigger Render Deploy (Prod)
        run: |
          echo "Deploying to Production Environment..."
          # Llamamos a los Hooks que guardaste en los secretos de 'Production'
          # Â¡El nombre es el mismo, pero el valor es el de PROD!
          curl -X POST ${{ secrets.RENDER_HOOK_BACKEND }}
          curl -X POST ${{ secrets.RENDER_HOOK_FRONTEND }}